<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>دستیار انتخاب واحد مکانیک - نسخه جامع</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/misc/Farsi-Digits/font-face.css" rel="stylesheet" type="text/css" />
    
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --border: #e0e0e0;
            --text: #333;
            --danger: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --tab-inactive: #ecf0f1;
        }

        * { box-sizing: border-box; outline: none; }

        body { 
            font-family: 'B Yekan', 'Vazirmatn', Tahoma, sans-serif; 
            background: var(--bg); 
            padding: 20px; 
            margin: 0;
            color: var(--text);
            height: 100vh;
            overflow: hidden; 
        }

        .container { 
            display: flex; 
            gap: 20px; 
            height: 95vh; 
        }

        /* --- ICONS & BUTTONS --- */
        .icon-btn {
            background: none; border: none; cursor: pointer; padding: 5px;
            display: inline-flex; align-items: center; justify-content: center;
            border-radius: 4px; transition: 0.2s; color: #95a5a6;
            z-index: 2;
        }
        .icon-btn:hover { background: rgba(0,0,0,0.05); color: var(--primary); }
        .icon-btn svg { width: 18px; height: 18px; fill: currentColor; }
        
        .btn-sm-danger { color: var(--danger); }
        .btn-sm-danger:hover { background: #fee; }

        /* --- RANK INDICATORS --- */
        .rank-dot {
            width: 8px; height: 8px; border-radius: 50%;
            display: inline-block; margin-left: 6px; vertical-align: middle;
        }
        .rank-g { background: #27ae60; box-shadow: 0 0 4px rgba(39, 174, 96, 0.4); } 
        .rank-y { background: #f1c40f; box-shadow: 0 0 4px rgba(241, 196, 15, 0.4); } 
        .rank-r { background: #e74c3c; box-shadow: 0 0 4px rgba(231, 76, 60, 0.4); } 

        /* --- SIDEBAR --- */
        .controls { 
            width: 420px; min-width: 420px;
            background: var(--card-bg); border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            display: flex; flex-direction: column; overflow: hidden;
            border: 1px solid white;
        }

        .sidebar-header {
            padding: 15px; background: var(--primary); color: white;
            display: flex; flex-direction: column; gap: 10px; flex-shrink: 0;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-top h3 { margin: 0; font-size: 1.2em; }

        /* --- PLAN TABS --- */
        .plan-tabs-wrapper {
            display: flex; align-items: center; gap: 5px; padding-bottom: 5px;
            overflow-x: auto; scrollbar-width: none;
        }
        
        .plan-tab {
            background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.8);
            border: 1px solid rgba(255,255,255,0.1); padding: 6px 12px;
            border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.9em;
            white-space: nowrap; transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .plan-tab.active { background: white; color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .add-btn-circle {
            background: var(--success); color: white; border: none;
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2em; cursor: pointer; flex-shrink: 0;
        }

        .search-box {
            width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px; background: rgba(255,255,255,0.15); color: white;
            font-family: inherit; text-align: center;
        }
        .search-box::placeholder { color: rgba(255,255,255,0.7); }

        .tabs { display: flex; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 10px; gap: 5px; }
        .tab-btn {
            flex: 1; background: transparent; border: none; color: rgba(255,255,255,0.7);
            padding: 8px; cursor: pointer; border-radius: 6px; font-family: inherit;
            font-size: 0.9em; transition: 0.2s;
        }
        .tab-btn.active { background: white; color: var(--primary); font-weight: bold; }

        .course-list { flex-grow: 1; overflow-y: auto; padding: 10px; scrollbar-width: thin; }

        /* --- ACCORDION & CHECKBOX UI --- */
        .course-group { 
            margin-bottom: 10px; border: 1px solid var(--border); 
            border-radius: 12px; background: white; overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .course-group.selected-course {
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            background: #fbfdff;
            order: -1;
        }

        .accordion-header {
            padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; user-select: none;
            background: #fff; font-weight: bold; font-size: 0.95em; transition: background 0.2s;
        }
        .accordion-header:hover { background: #f8f9fa; }
        
        .header-main { 
            display: flex; align-items: center; gap: 12px; flex: 1; 
        }
        
        .custom-checkbox {
            width: 20px; height: 20px; border-radius: 6px;
            border: 2px solid #ddd; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; flex-shrink: 0; background: white; cursor: pointer;
        }
        .custom-checkbox svg { width: 14px; height: 14px; fill: white; opacity: 0; transform: scale(0.5); transition: 0.2s; }
        
        .course-group.selected-course .custom-checkbox {
            background: var(--course-color);
            border-color: var(--course-color);
        }
        .course-group.selected-course .custom-checkbox svg { opacity: 1; transform: scale(1); }

        .header-actions { display: flex; align-items: center; gap: 5px; }

        .accordion-body {
            max-height: 0; opacity: 0; overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            background: #fafafa; border-top: 1px solid #eee;
        }
        .accordion-body.open { max-height: 2000px; opacity: 1; padding: 10px; }

        .prof-grid { display: grid; gap: 6px; }
        .prof-option { position: relative; cursor: pointer; display: block; }
        .prof-option input { position: absolute; opacity: 0; width: 0; height: 0; }
        
        .prof-card {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; background: white; border: 2px solid transparent;
            border-radius: 8px; font-size: 0.85em; color: #555;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;
        }
        .prof-card:hover { border-color: #d6eaf8; }
        
        .prof-option input:checked + .prof-card {
            background: var(--accent); color: white; border-color: var(--accent);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        /* --- SIDEBAR FOOTER & CREDITS --- */
        .sidebar-footer {
            padding: 15px; border-top: 1px solid var(--border); background: #fafafa; 
            display: flex; flex-direction: column; gap: 15px;
        }
        .footer-buttons { display: flex; gap: 10px; width: 100%; }
        
        .btn-block {
            flex: 1; padding: 12px; border-radius: 8px; cursor: pointer; font-family: inherit; border: none; font-weight: bold;
        }
        .reset-btn { background: #fff; border: 1px solid var(--danger); color: var(--danger); }
        .add-course-btn { background: var(--primary); color: white; }

        .credits-container {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            border-top: 1px dashed #ddd; padding-top: 15px;
            direction: rtl;
        }
        
        .credits-title {
            font-size: 0.85rem; font-weight: 800; color: #7f8c8d;
            margin-bottom: 2px;
        }
        
        .dev-list {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; align-items: center;
            font-size: 0.8rem;
        }
        
        .dev-link {
            text-decoration: none; color: #555; font-weight: 500; transition: color 0.2s;
            position: relative;
        }
        .dev-link:hover { color: var(--accent); text-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        .dev-sep { color: #ccc; font-size: 0.8em; }

        /* --- SCHEDULE --- */
        .schedule { 
            flex-grow: 1; background: var(--card-bg); border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; 
            border: 1px solid white; display: flex; flex-direction: column; position: relative;
        }

        .schedule-scroll { overflow-y: auto; height: 100%; position: relative; scrollbar-width: thin; }

        .day-header { 
            display: flex; position: sticky; top: 0; z-index: 100;
            background: #fff; border-bottom: 2px solid var(--border); 
        }
        .day-col { 
            flex: 1; text-align: center; padding: 15px 0; 
            font-weight: bold; color: #555; border-left: 1px solid #eee;
        }
        .time-header-spacer { width: 50px; border-left: 2px solid var(--border); background: #fafafa; }
        
        .grid-container { display: flex; position: relative; }
        .time-labels { 
            width: 50px; background: #fafafa; border-left: 2px solid var(--border);
            flex-shrink: 0; display: flex; flex-direction: column;
        }
        .time-label { 
            height: 60px; display: flex; align-items: start; justify-content: center; 
            font-size: 0.8em; color: #888; transform: translateY(-10px); 
        }

        .day-lane { 
            flex: 1; border-left: 1px solid #f0f0f0; position: relative; 
            background: repeating-linear-gradient(to bottom, transparent 0 59px, #eee 59px 60px); 
        }

        .event { 
            position: absolute; border-radius: 4px; color: white; 
            font-size: 0.75em; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.15); padding: 2px 4px;
            overflow: hidden; transition: transform 0.2s; z-index: 10;
            border-top: 3px solid rgba(255,255,255,0.4); cursor: pointer;
            white-space: normal; word-wrap: break-word; line-height: 1.2; user-select: none;
        }
        .event:hover { z-index: 50 !important; transform: scale(1.03); }

        /* Colors */
        .c-sp-1 { background: #e74c3c; } .c-sp-2 { background: #e67e22; }
        .c-sp-3 { background: #f1c40f; color: #333 !important; } .c-sp-4 { background: #2ecc71; }
        .c-sp-5 { background: #1abc9c; } .c-sp-6 { background: #3498db; }
        .c-sp-7 { background: #9b59b6; } .c-sp-8 { background: #34495e; }
        .c-gen { background: #95a5a6; }
        .conflict-overlap { opacity: 0.9; box-shadow: 0 0 0 2px #fff; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        
        .modal-box {
            background: white; width: 95%; max-width: 600px;
            border-radius: 12px; padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: translateY(20px); transition: 0.3s;
            max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;
        }
        .modal-overlay.active .modal-box { transform: translateY(0); }
        
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-title { margin: 0; color: var(--primary); }
        
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-input, .form-select {
            width: 100%; padding: 10px; border: 1px solid #ddd;
            border-radius: 6px; font-family: inherit;
        }
        
        .dynamic-list-container { border: 1px solid #eee; border-radius: 8px; padding: 10px; background: #fafafa; margin-bottom: 10px; }
        .prof-entry-card { background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; position: relative; }
        .prof-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .time-slot-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-family: inherit; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #ecf0f1; color: #333; }
        .btn-cancel { background: #eee; color: #555; }
        .btn-danger { background: #fee; color: var(--danger); }
        .btn-sm { padding: 4px 8px; font-size: 0.85em; }

        .desktop-only { display: inline; }
        .mobile-text { display: none; }

        @media (max-width: 900px) {
            body { height: auto; overflow: auto; padding: 10px; }
            .container { flex-direction: column-reverse; height: auto; gap: 10px; }
            .controls { width: 100%; min-width: 0; height: auto; }
            .course-list { max-height: 400px; }
            .schedule { width: 100%; height: auto; }
            .time-header-spacer, .time-labels { width: 30px; }
            .time-label { font-size: 0.7em; margin-right: -5px; }
            .day-col .desktop-text { display: none; }
            .day-col .mobile-text { display: inline; }
            .day-col { padding: 10px 0; font-size: 0.9em; }
            .desktop-only { display: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="controls">
        <div class="sidebar-header">
            <div class="header-top">
                <h3>دستیار انتخاب واحد</h3>
            </div>
            <div class="plan-tabs-wrapper" id="planTabsContainer">
                <button class="add-btn-circle" onclick="addNewPlan()" title="ایجاد برنامه جدید">+</button>
            </div>
            <input type="text" id="searchInput" class="search-box" placeholder="جستجو..." onkeyup="renderCourseList()">
            <div class="tabs">
                <button class="tab-btn active" onclick="setTab('specialized')">تخصصی</button>
                <button class="tab-btn" onclick="setTab('general')">عمومی</button>
            </div>
        </div>
        <div class="course-list" id="accordion-container"></div>
        <div class="sidebar-footer">
            <div class="footer-buttons">
                <button class="btn-block add-course-btn" onclick="openAddModal()">+ افزودن درس جدید</button>
                <button class="btn-block reset-btn" onclick="deleteCurrentPlan()">حذف برنامه</button>
            </div>
            
            <div class="credits-container">
                <div class="credits-title">طراحی و اجرا</div>
                <div class="dev-list">
                    <a href="https://t.me/AmiraliNotFoundd" target="_blank" class="dev-link">امیرعلی نویدی</a>
                    <span class="dev-sep">•</span>
                    <a href="https://t.me/SinaSharifi7462" target="_blank" class="dev-link">سینا شریفی</a>
                    <span class="dev-sep">•</span>
                    <a href="https://t.me/T_acrisius" target="_blank" class="dev-link">محمد کشتکار</a>
                </div>
            </div>
            </div>
    </div>

    <div class="schedule">
        <div class="schedule-scroll">
            <div class="day-header">
                <div class="time-header-spacer"></div>
                <div class="day-col"><span class="desktop-text">شنبه</span><span class="mobile-text">ش</span></div>
                <div class="day-col"><span class="desktop-text">یک‌شنبه</span><span class="mobile-text">۱ش</span></div>
                <div class="day-col"><span class="desktop-text">دوشنبه</span><span class="mobile-text">۲ش</span></div>
                <div class="day-col"><span class="desktop-text">سه‌شنبه</span><span class="mobile-text">۳ش</span></div>
                <div class="day-col"><span class="desktop-text">چهارشنبه</span><span class="mobile-text">۴ش</span></div>
            </div>
            <div class="grid-container">
                <div class="time-labels" id="timeLabels"></div>
                <div class="day-lane" id="day-0"></div> 
                <div class="day-lane" id="day-1"></div> 
                <div class="day-lane" id="day-2"></div> 
                <div class="day-lane" id="day-3"></div> 
                <div class="day-lane" id="day-4"></div> 
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="editModal">
    <div class="modal-box">
        <div class="modal-header">
            <h3 class="modal-title">ویرایش درس</h3>
            <button class="icon-btn" onclick="closeModal('editModal')">✕</button>
        </div>
        <div id="editModalContent"></div>
    </div>
</div>

<div class="modal-overlay" id="addModal">
    <div class="modal-box">
        <div class="modal-header">
            <h3 class="modal-title">افزودن درس سفارشی</h3>
            <button class="icon-btn" onclick="closeModal('addModal')">✕</button>
        </div>
        
        <div class="form-group">
            <label class="form-label">نام درس</label>
            <input type="text" id="ncName" class="form-input" placeholder="مثلا: فیزیک ۲">
        </div>
        <div class="form-group">
            <label class="form-label">دسته بندی</label>
            <select id="ncCat" class="form-select">
                <option value="specialized">تخصصی</option>
                <option value="general">عمومی</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">اساتید / گروه‌ها</label>
            <div id="ncProfsContainer" class="dynamic-list-container"></div>
            <button class="btn btn-secondary btn-sm" onclick="addProfField()" style="width:100%">+ افزودن استاد</button>
        </div>

        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="closeModal('addModal')">انصراف</button>
            <button class="btn btn-primary" onclick="submitNewCourse()">ثبت درس</button>
        </div>
    </div>
</div>

<script>
    const START_HOUR = 7; 
    const END_HOUR = 18;  
    const PX_PER_HOUR = 60;
    const STORAGE_KEY = 'course_planner_v9';
    const COURSE_DATA_KEY = 'course_data_v9';

    const icons = {
        pencil: '<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>',
        trash: '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>',
        check: '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>'
    };

    const shor
