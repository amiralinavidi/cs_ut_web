<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>دستیار انتخاب واحد مکانیک - نسخه نهایی</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/misc/Farsi-Digits/font-face.css" rel="stylesheet" type="text/css" />
    
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --border: #e0e0e0;
            --text: #333;
            --text-secondary: #555;
            --danger: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --input-bg: #fff;
            --input-border: #ddd;
            --hover-bg: #f8f9fa;
            --header-text: white;
            
            /* Scrollbar Colors (Light) */
            --scroll-track: #f0f0f0;
            --scroll-thumb: #ccc;
            --scroll-thumb-hover: #bbb;
        }

        [data-theme="dark"] {
            --primary: #34495e;
            --accent: #3498db;
            --bg: #121212;
            --card-bg: #1e1e1e;
            --border: #333;
            --text: #e0e0e0;
            --text-secondary: #aaa;
            --danger: #cf6679;
            --success: #81c784;
            --warning: #ffb74d;
            --input-bg: #2c2c2c;
            --input-border: #444;
            --hover-bg: #2a2a2a;
            --header-text: #e0e0e0;

            /* Scrollbar Colors (Dark) */
            --scroll-track: #1e1e1e;
            --scroll-thumb: #444;
            --scroll-thumb-hover: #555;
        }

        * { box-sizing: border-box; outline: none; }

        /* --- CUSTOM SCROLLBARS --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--scroll-track); 
        }
        ::-webkit-scrollbar-thumb {
            background: var(--scroll-thumb); 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--scroll-thumb-hover); 
        }
        /* Firefox Scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--scroll-thumb) var(--scroll-track);
        }

        body { 
            font-family: 'B Yekan', 'Vazirmatn', Tahoma, sans-serif; 
            background: var(--bg); 
            padding: 20px; 
            margin: 0;
            color: var(--text);
            height: 100vh;
            overflow: hidden; 
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container { 
            display: flex; 
            gap: 20px; 
            height: 95vh; 
        }

        /* --- ICONS & BUTTONS --- */
        .icon-btn {
            background: none; border: none; cursor: pointer; padding: 5px;
            display: inline-flex; align-items: center; justify-content: center;
            border-radius: 4px; transition: 0.2s; color: #95a5a6;
            z-index: 2;
        }
        .icon-btn:hover { background: rgba(0,0,0,0.1); color: var(--text); }
        .icon-btn svg { width: 18px; height: 18px; fill: currentColor; }
        
        .btn-sm-danger { color: var(--danger); }
        .btn-sm-danger:hover { background: rgba(231, 76, 60, 0.1); }

        /* --- THEME TOGGLE ANIMATION --- */
        .theme-toggle {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            overflow: hidden;
            transition: background 0.3s;
        }
        .theme-toggle:hover { background: rgba(255,255,255,0.25); }

        .t-icon {
            position: absolute;
            width: 20px;
            height: 20px;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .t-icon-moon { opacity: 1; transform: rotate(0deg) scale(1); }
        [data-theme="dark"] .t-icon-moon { opacity: 0; transform: rotate(90deg) scale(0); }

        .t-icon-sun { opacity: 0; transform: rotate(-90deg) scale(0); }
        [data-theme="dark"] .t-icon-sun { opacity: 1; transform: rotate(0deg) scale(1); }

        /* --- RANK INDICATORS --- */
        .rank-dot {
            width: 8px; height: 8px; border-radius: 50%;
            display: inline-block; margin-left: 6px; vertical-align: middle;
        }
        .rank-g { background: #27ae60; box-shadow: 0 0 4px rgba(39, 174, 96, 0.4); } 
        .rank-y { background: #f1c40f; box-shadow: 0 0 4px rgba(241, 196, 15, 0.4); } 
        .rank-r { background: #e74c3c; box-shadow: 0 0 4px rgba(231, 76, 60, 0.4); } 

        /* --- SIDEBAR --- */
        .controls { 
            width: 420px; min-width: 420px;
            background: var(--card-bg); border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            display: flex; flex-direction: column; overflow: hidden;
            border: 1px solid var(--border);
        }

        .sidebar-header {
            padding: 15px; background: var(--primary); color: var(--header-text);
            display: flex; flex-direction: column; gap: 10px; flex-shrink: 0;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-top h3 { margin: 0; font-size: 1.2em; }
        
        /* Unit Counter Styles */
        .unit-counter-box {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.15); padding: 8px 12px;
            border-radius: 8px; font-weight: bold; font-size: 0.95em;
            border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease;
        }
        .unit-counter-box.limit-exceeded {
            background: rgba(231, 76, 60, 0.25);
            border-color: #e74c3c;
            color: #ffcccc;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        /* --- PLAN TABS --- */
        .plan-tabs-wrapper {
            display: flex; align-items: center; gap: 5px; padding-bottom: 5px;
            overflow-x: auto; scrollbar-width: none;
        }
        
        .plan-tab {
            background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.8);
            border: 1px solid rgba(255,255,255,0.1); padding: 6px 12px;
            border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.9em;
            white-space: nowrap; transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .plan-tab.active { background: var(--card-bg); color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .add-btn-circle {
            background: var(--success); color: white; border: none;
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2em; cursor: pointer; flex-shrink: 0;
        }

        .search-box {
            width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px; background: rgba(255,255,255,0.15); color: white;
            font-family: inherit; text-align: center;
        }
        .search-box::placeholder { color: rgba(255,255,255,0.7); }

        .tabs { display: flex; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 10px; gap: 5px; }
        .tab-btn {
            flex: 1; background: transparent; border: none; color: rgba(255,255,255,0.7);
            padding: 8px; cursor: pointer; border-radius: 6px; font-family: inherit;
            font-size: 0.9em; transition: 0.2s;
        }
        .tab-btn.active { background: var(--card-bg); color: var(--primary); font-weight: bold; }

        .course-list { flex-grow: 1; overflow-y: auto; padding: 10px; }

        /* --- ACCORDION & CHECKBOX UI --- */
        .course-group { 
            margin-bottom: 10px; border: 1px solid var(--border); 
            border-radius: 12px; background: var(--card-bg); overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .course-group.selected-course {
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            background: var(--card-bg);
            order: -1;
        }

        .accordion-header {
            padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; user-select: none; color: var(--text);
            background: var(--card-bg); font-weight: bold; font-size: 0.95em; transition: background 0.2s;
        }
        .accordion-header:hover { background: var(--hover-bg); }
        
        .header-main { 
            display: flex; align-items: center; gap: 12px; flex: 1; 
        }
        
        .course-units-badge {
            font-size: 0.75em; font-weight: normal; color: var(--text-secondary);
            background: var(--bg); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border);
        }
        
        .custom-checkbox {
            width: 20px; height: 20px; border-radius: 6px;
            border: 2px solid var(--border); display: flex; align-items: center; justify-content: center;
            transition: 0.2s; flex-shrink: 0; background: var(--card-bg); cursor: pointer;
        }
        .custom-checkbox svg { width: 14px; height: 14px; fill: white; opacity: 0; transform: scale(0.5); transition: 0.2s; }
        
        .course-group.selected-course .custom-checkbox {
            background: var(--course-color);
            border-color: var(--course-color);
        }
        .course-group.selected-course .custom-checkbox svg { opacity: 1; transform: scale(1); }

        .header-actions { display: flex; align-items: center; gap: 5px; }

        .accordion-body {
            max-height: 0; opacity: 0; overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            background: var(--bg); border-top: 1px solid var(--border);
        }
        .accordion-body.open { max-height: 2000px; opacity: 1; padding: 10px; }

        .prof-grid { display: grid; gap: 6px; }
        .prof-option { position: relative; cursor: pointer; display: block; }
        .prof-option input { position: absolute; opacity: 0; width: 0; height: 0; }
        
        .prof-card {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; background: var(--card-bg); border: 2px solid transparent;
            border-radius: 8px; font-size: 0.85em; color: var(--text-secondary);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;
        }
        .prof-card:hover { border-color: var(--accent); }
        
        .prof-option input:checked + .prof-card {
            background: var(--accent); color: white; border-color: var(--accent);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        .prof-option input:checked + .prof-card span { color: white; }

        /* --- SIDEBAR FOOTER & CREDITS --- */
        .sidebar-footer {
            padding: 15px; border-top: 1px solid var(--border); background: var(--bg); 
            display: flex; flex-direction: column; gap: 15px;
        }
        .footer-buttons { display: flex; gap: 10px; width: 100%; }
        
        .btn-block {
            flex: 1; padding: 12px; border-radius: 8px; cursor: pointer; font-family: inherit; border: none; font-weight: bold;
        }
        .reset-btn { background: var(--card-bg); border: 1px solid var(--danger); color: var(--danger); }
        .add-course-btn { background: var(--primary); color: white; }

        .credits-container {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            border-top: 1px dashed var(--border); padding-top: 15px;
            direction: rtl;
        }
        
        .credits-title {
            font-size: 0.85rem; font-weight: 800; color: #7f8c8d;
            margin-bottom: 2px;
        }
        
        .dev-list {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; align-items: center;
            font-size: 0.8rem;
        }
        
        .dev-link {
            text-decoration: none; color: var(--text-secondary); font-weight: 500; transition: color 0.2s;
            position: relative;
        }
        .dev-link:hover { color: var(--accent); text-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        .dev-sep { color: #ccc; font-size: 0.8em; }

        /* --- SCHEDULE --- */
        .schedule { 
            flex-grow: 1; background: var(--card-bg); border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; 
            border: 1px solid var(--border); display: flex; flex-direction: column; position: relative;
        }

        .schedule-scroll { overflow-y: auto; height: 100%; position: relative; }

        .day-header { 
            display: flex; position: sticky; top: 0; z-index: 100;
            background: var(--card-bg); border-bottom: 2px solid var(--border); 
        }
        .day-col { 
            flex: 1; text-align: center; padding: 15px 0; 
            font-weight: bold; color: var(--text-secondary); border-left: 1px solid var(--border);
        }
        .time-header-spacer { width: 50px; border-left: 2px solid var(--border); background: var(--bg); }
        
        .grid-container { display: flex; position: relative; }
        .time-labels { 
            width: 50px; background: var(--bg); border-left: 2px solid var(--border);
            flex-shrink: 0; display: flex; flex-direction: column;
        }
        .time-label { 
            height: 60px; display: flex; align-items: start; justify-content: center; 
            font-size: 0.8em; color: var(--text-secondary); transform: translateY(-10px); 
        }

        .day-lane { 
            flex: 1; border-left: 1px solid var(--border); position: relative; 
            background: repeating-linear-gradient(to bottom, transparent 0 59px, var(--border) 59px 60px); 
        }

        .event { 
            position: absolute; border-radius: 4px; color: white; 
            font-size: 0.75em; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.15); padding: 2px 4px;
            overflow: hidden; transition: transform 0.2s; z-index: 10;
            border-top: 3px solid rgba(255,255,255,0.4); cursor: pointer;
            white-space: normal; word-wrap: break-word; line-height: 1.2; user-select: none;
        }
        .event:hover { z-index: 50 !important; transform: scale(1.03); }
        
        .deletion-hint {
            text-align: center; font-size: 0.8rem; color: var(--text-secondary);
            padding: 8px; border-top: 1px solid var(--border); background: var(--bg);
        }

        /* Colors */
        .c-sp-1 { background: #e74c3c; } .c-sp-2 { background: #e67e22; }
        .c-sp-3 { background: #f1c40f; color: #333 !important; } .c-sp-4 { background: #2ecc71; }
        .c-sp-5 { background: #1abc9c; } .c-sp-6 { background: #3498db; }
        .c-sp-7 { background: #9b59b6; } .c-sp-8 { background: #34495e; }
        .c-gen { background: #95a5a6; }
        .conflict-overlap { opacity: 0.9; box-shadow: 0 0 0 2px #fff; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        
        .modal-box {
            background: var(--card-bg); width: 95%; max-width: 600px;
            border-radius: 12px; padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: translateY(20px); transition: 0.3s;
            max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;
            color: var(--text);
            border: 1px solid var(--border);
        }
        .modal-overlay.active .modal-box { transform: translateY(0); }
        
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .modal-title { margin: 0; color: var(--primary); }
        [data-theme="dark"] .modal-title { color: var(--text); }
        
        .form-group { margin-bottom: 15px; }
        .form-row { display: flex; gap: 10px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-input, .form-select {
            width: 100%; padding: 10px; border: 1px solid var(--input-border);
            border-radius: 6px; font-family: inherit; background: var(--input-bg);
            color: var(--text);
        }
        
        .dynamic-list-container { border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: var(--bg); margin-bottom: 10px; }
        .prof-entry-card { background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 10px; position: relative; }
        .prof-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .time-slot-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-family: inherit; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--border); color: var(--text); }
        .btn-cancel { background: var(--bg); color: var(--text-secondary); }
        .btn-danger { background: rgba(231, 76, 60, 0.1); color: var(--danger); }
        .btn-sm { padding: 4px 8px; font-size: 0.85em; }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-footer-left { display: flex; gap: 10px; }
        .modal-footer-right { display: flex; gap: 10px; }

        .desktop-only { display: inline; }
        .mobile-text { display: none; }

        @media (max-width: 900px) {
            body { height: auto; overflow: auto; padding: 10px; }
            .container { flex-direction: column-reverse; height: auto; gap: 10px; }
            .controls { width: 100%; min-width: 0; height: auto; }
            .course-list { max-height: 400px; }
            .schedule { width: 100%; height: auto; }
            .time-header-spacer, .time-labels { width: 30px; }
            .time-label { font-size: 0.7em; margin-right: -5px; }
            .day-col .desktop-text { display: none; }
            .day-col .mobile-text { display: inline; }
            .day-col { padding: 10px 0; font-size: 0.9em; }
            .desktop-only { display: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="controls">
        <div class="sidebar-header">
            <div class="header-top">
                <h3>دستیار انتخاب واحد</h3>
                <button class="theme-toggle" id="themeToggleBtn" onclick="toggleTheme()" title="تغییر تم">
                    <svg class="t-icon t-icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    <svg class="t-icon t-icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </button>
            </div>
            
            <div class="unit-counter-box" id="unitBox">
                <span>تعداد واحد انتخاب شده:</span>
                <span id="unitDisplay" style="font-size:1.2em">0</span>
            </div>

            <div class="plan-tabs-wrapper" id="planTabsContainer">
                <button class="add-btn-circle" onclick="addNewPlan()" title="ایجاد برنامه جدید">+</button>
            </div>
            <input type="text" id="searchInput" class="search-box" placeholder="جستجو..." onkeyup="renderCourseList()">
            <div class="tabs">
                <button class="tab-btn active" onclick="setTab('specialized')">تخصصی</button>
                <button class="tab-btn" onclick="setTab('general')">عمومی</button>
            </div>
        </div>
        <div class="course-list" id="accordion-container"></div>
        <div class="sidebar-footer">
            <div class="footer-buttons">
                <button class="btn-block add-course-btn" onclick="openCourseModal('add')">+ افزودن درس جدید</button>
                <button class="btn-block reset-btn" onclick="deleteCurrentPlan()">حذف برنامه</button>
            </div>
            
            <div class="credits-container">
                <div class="credits-title">طراحی و اجرا</div>
                <div class="dev-list">
                    <a href="https://t.me/AmiraliNotFoundd" target="_blank" class="dev-link">امیرعلی نویدی</a>
                    <span class="dev-sep">•</span>
                    <a href="https://t.me/SinaSharifi7462" target="_blank" class="dev-link">سینا شریفی</a>
                    <span class="dev-sep">•</span>
                    <a href="https://t.me/T_acrisius" target="_blank" class="dev-link">محمد کشتکار</a>
                </div>
            </div>
            </div>
    </div>

    <div class="schedule">
        <div class="schedule-scroll">
            <div class="day-header">
                <div class="time-header-spacer"></div>
                <div class="day-col"><span class="desktop-text">شنبه</span><span class="mobile-text">ش</span></div>
                <div class="day-col"><span class="desktop-text">یک‌شنبه</span><span class="mobile-text">۱ش</span></div>
                <div class="day-col"><span class="desktop-text">دوشنبه</span><span class="mobile-text">۲ش</span></div>
                <div class="day-col"><span class="desktop-text">سه‌شنبه</span><span class="mobile-text">۳ش</span></div>
                <div class="day-col"><span class="desktop-text">چهارشنبه</span><span class="mobile-text">۴ش</span></div>
            </div>
            <div class="grid-container">
                <div class="time-labels" id="timeLabels"></div>
                <div class="day-lane" id="day-0"></div> 
                <div class="day-lane" id="day-1"></div> 
                <div class="day-lane" id="day-2"></div> 
                <div class="day-lane" id="day-3"></div> 
                <div class="day-lane" id="day-4"></div> 
            </div>
        </div>
        <div class="deletion-hint">
            برای حذف درس از برنامه، روی آن در جدول <b>دوبار کلیک</b> کنید (در موبایل نگه دارید)
        </div>
    </div>
</div>

<div class="modal-overlay" id="courseModal">
    <div class="modal-box">
        <div class="modal-header">
            <h3 class="modal-title" id="courseModalTitle">مدیریت درس</h3>
            <button class="icon-btn" onclick="closeModal('courseModal')">✕</button>
        </div>
        
        <div class="form-row">
            <div class="form-group" style="flex:2">
                <label class="form-label">نام درس</label>
                <input type="text" id="ncName" class="form-input" placeholder="مثلا: فیزیک ۲">
            </div>
            <div class="form-group" style="flex:1">
                <label class="form-label">تعداد واحد</label>
                <input type="number" id="ncUnits" class="form-input" min="0" max="9" value="3">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">دسته بندی</label>
            <select id="ncCat" class="form-select">
                <option value="specialized">تخصصی</option>
                <option value="general">عمومی</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">اساتید / گروه‌ها</label>
            <div id="ncProfsContainer" class="dynamic-list-container"></div>
            <button class="btn btn-secondary btn-sm" onclick="addProfField()" style="width:100%">+ افزودن استاد</button>
        </div>

        <div class="modal-footer">
            <div class="modal-footer-right">
                <button class="btn btn-cancel" onclick="closeModal('courseModal')">انصراف</button>
                <button id="deleteCourseBtn" class="btn btn-danger" style="display:none;" onclick="deleteEntireCourse()">حذف درس</button>
            </div>
            <button class="btn btn-primary" onclick="submitCourseForm()">ثبت تغییرات</button>
        </div>
    </div>
</div>

<script>
    const START_HOUR = 7; 
    const END_HOUR = 18;  
    const PX_PER_HOUR = 60;
    const STORAGE_KEY = 'course_planner_v10';
    const COURSE_DATA_KEY = 'course_data_v10';
    const THEME_KEY = 'theme_pref_v1';
    const dayNames = ['شنبه', '۱شنبه', '۲شنبه', '۳شنبه', '۴شنبه'];

    const icons = {
        pencil: '<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>',
        trash: '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>',
        check: '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>'
    };

    const shortNames = { 'ارتعاشات مکانیکی': 'ارتعاشات', 'ترمودینامیک ۱': 'ترمو۱', 'طراحی اجزاء ماشین 1': 'اجزا۱', 'مکانیک سیالات ۱': 'سیالات۱', 'آزمایشگاه مکانیک مواد': 'آز مواد', 'آمار و احتمال مهندسی': 'آمار', 'مبانی مدارهای الکتریکی': 'مدار', 'مکانیک مواد ۲': 'مقاومت۲', 'برنامه سازی پیشرفته': 'برنامه‌سازی', 'اندیشه اسلامی ۱': 'اندیشه۱', 'اندیشه اسلامی ۲': 'اندیشه۲', 'انقلاب اسلامی': 'انقلاب', 'دانش خانواده': 'خانواده', 'ریاضی عمومی ۱': 'ریاضی۱', 'فیزیک ۱': 'فیزیک۱', 'نقشه کشی صنعتی ۱': 'نقشه۱', 'برنامه‌سازی کامپیوتر': 'برنامه', 'آزمایشگاه فیزیک ۱': 'آز فیزیک۱', 'استاتیک': 'استاتیک', 'ریاضی عمومی ۲': 'ریاضی۲', 'معادلات دیفرانسیل': 'معادلات', 'شیمی فیزیک': 'شیمی‌فیزیک', 'فیزیک ۲': 'فیزیک۲', 'درآمدی بر مهندسی مکانیک': 'درآمد', 'دینامیک': 'دینامیک', 'علم مواد': 'علم‌مواد', 'مکانیک مواد ۱': 'مقاومت۱', 'ریاضی مهندسی': 'ریاضی‌مهندسی', 'محاسبات عددی': 'محاسبات', 'کارگاه ماشین ابزار': 'ماشین‌ابزار', 'آزمایشگاه فیزیک ۲': 'آز فیزیک۲' };

    // Added 'u' property for units based on image data
    const defaultCourses = [
        { id: '8106007', t: 'ارتعاشات مکانیکی', c: 'specialized', u: 3, g: [{i: '01', p: 'بهرامی آرش', x: 'مختلط', t: [{d:0,s:10.5,e:12}, {d:2,s:10.5,e:12}]}]},
        { id: '8106090', t: 'ترمودینامیک ۱', c: 'specialized', u: 3, g: [{i: '02', p: 'کوثری فرشاد', x: 'مختلط', t: [{d:1,s:9,e:10.5}, {d:3,s:9,e:10.5}]}, {i: '03', p: 'افشاری اصغر', x: 'مختلط', t: [{d:1,s:10.5,e:12}, {d:3,s:10.5,e:12}]}]},
        { id: '8106164', t: 'طراحی اجزاء ماشین 1', c: 'specialized', u: 3, g: [{i: '01', p: 'صفرآبادی مجید', x: 'مختلط', t: [{d:0,s:10.5,e:12}, {d:2,s:10.5,e:12}]}, {i: '02', p: 'عطائی علی اصغر', x: 'مختلط', t: [{d:1,s:9,e:10.5}, {d:3,s:9,e:10.5}]}]},
        { id: '8106272', t: 'مکانیک سیالات ۱', c: 'specialized', u: 3, g: [{i: '01', p: 'صادقی کیوان', x: 'مختلط', t: [{d:0,s:9,e:10.5}, {d:2,s:9,e:10.5}]}, {i: '02', p: 'جلالی علیرضا', x: 'مختلط', t: [{d:0,s:13.5,e:15}, {d:2,s:13.5,e:15}]}, {i: '03', p: 'نجات امیر', x: 'مختلط', t: [{d:1,s:13.5,e:15}, {d:3,s:13.5,e:15}]}]},
        { id: '8106350', t: 'آزمایشگاه مکانیک مواد', c: 'specialized', u: 1, g: [{i: '01', p: 'گنجیانی', x: 'مختلط', t: [{d:1,s:15,e:17}]}, {i: '02', p: 'گنجیانی', x: 'مختلط', t: [{d:2,s:13,e:15}]}, {i: '03', p: 'گنجیانی', x: 'مختلط', t: [{d:3,s:15,e:17}]}]},
        { id: '8106378', t: 'آمار و احتمال مهندسی', c: 'specialized', u: 3, g: [{i: '01', p: 'حسینیان احسان', x: 'مختلط', t: [{d:0,s:10.5,e:12}, {d:2,s:10.5,e:12}]}, {i: '02', p: 'شکر ایمان', x: 'مختلط', t: [{d:1,s:9,e:10.5}, {d:3,s:9,e:10.5}]}]},
        { id: '8106483', t: 'مبانی مدارهای الکتریکی', c: 'specialized', u: 3, g: [{i: '01', p: 'فرج زاده', x: 'مختلط', t: [{d:0,s:7.5,e:9}, {d:2,s:7.5,e:9}]}, {i: '02', p: 'فرج زاده', x: 'مختلط', t: [{d:0,s:9,e:10.5}, {d:2,s:9,e:10.5}]}]},
        { id: '8106514', t: 'مکانیک مواد ۲', c: 'specialized', u: 2, g: [{i: '01', p: 'حقیقی یزدی', x: 'مختلط', t: [{d:2,s:15,e:17}]}, {i: '02', p: 'معصومی', x: 'مختلط', t: [{d:1,s:15,e:17}]}]},
        { id: '8120096', t: 'محاسبات عددی', c: 'specialized', u: 2, g: [{i: '01', p: 'بیگ‌ پوریان', x: 'مختلط', t: [{d:0,s:10.5,e:12}]}, {i: '02', p: 'فهیم (۱)', x: 'مختلط', t: [{d:1,s:13.5,e:15}]}, {i: '03', p: 'فهیم (۲)', x: 'مختلط', t: [{d:2,s:13.5,e:15}]}, {i: '04', p: 'فاضلی', x: 'مختلط', t: [{d:1,s:15,e:16.5}]}]},
        { id: '1120001', t: 'اندیشه اسلامی ۱', c: 'general', u: 2, g: [{i: '01', p: 'موسوی فراز', x: 'زن', r: 'y', t: [{d:0,s:10,e:12}]}, {i: '02', p: 'خادمی مهدی', x: 'مرد', t: [{d:0,s:10,e:12}]}, {i: '03', p: 'حسینی مصطفی', x: 'زن', t: [{d:4,s:8,e:10}]}, {i: '04', p: 'حسینی مصطفی', x: 'مرد', t: [{d:4,s:10,e:12}]}, {i: '05', p: 'موسوی‌نسب', x: 'مرد', t: [{d:4,s:8,e:10}]}, {i: '06', p: 'موسوی‌نسب', x: 'زن', t: [{d:4,s:10,e:12}]}, {i: '07', p: 'خادمی مهدی', x: 'زن', t: [{d:0,s:13,e:15}]}, {i: '08', p: 'خادمی مهدی', x: 'مرد', t: [{d:0,s:15,e:17}]}, {i: '09', p: 'خازنی سجاد', x: 'زن', t: [{d:0,s:13,e:15}]}, {i: '10', p: 'خازنی سجاد', x: 'مرد', t: [{d:0,s:15,e:17}]}, {i: '11', p: 'قربانی عباس', x: 'مرد', r: 'r', t: [{d:3,s:7.5,e:9.5}]}, {i: '12', p: 'قربانی عباس', x: 'مرد', r: 'r', t: [{d:3,s:9.5,e:11.5}]}]},
        { id: '1120002', t: 'اندیشه اسلامی ۲', c: 'general', u: 2, g: [{i: '04', p: 'موسوی فراز', x: 'زن', r: 'y', t: [{d:4,s:10,e:12}]}, {i: '05', p: 'میر منصور', x: 'زن', r: 'r', t: [{d:4,s:8,e:10}]}, {i: '06', p: 'میر منصور', x: 'مرد', r: 'r', t: [{d:4,s:10,e:12}]}, {i: '07', p: 'واعظی بهروز', x: 'مرد', r: 'r', t: [{d:4,s:13,e:15}]}, {i: '08', p: 'جمال‌زاده', x: 'زن', t: [{d:4,s:15,e:17}]}, {i: '09', p: 'قرنی احسان', x: 'مرد', r: 'g', t: [{d:1,s:8,e:10}]}, {i: '10', p: 'قرنی احسان', x: 'زن', r: 'g', t: [{d:1,s:10,e:12}]}, {i: '11', p: 'فقیهی سیدمجتبی', x: 'مرد', t: [{d:3,s:13.5,e:15}]}, {i: '12', p: 'فقیهی سیدمجتبی', x: 'مرد', t: [{d:3,s:15,e:17}]}, {i: '13', p: 'میر منصور', x: 'زن', r: 'r', t: [{d:3,s:8,e:10}]}, {i: '14', p: 'میر منصور', x: 'مرد', r: 'r', t: [{d:3,s:10,e:12}]}, {i: '15', p: 'گروه آموزشی', x: 'زن', t: [{d:2,s:10,e:12}]}, {i: '16', p: 'دهقانی زهیر', x: 'زن', r: 'g', t: [{d:2,s:13,e:15}]}, {i: '19', p: 'شایسته حسین', x: 'زن', r: 'g', t: [{d:2,s:8,e:10}]}, {i: '20', p: 'شایسته حسین', x: 'مرد', r: 'g', t: [{d:2,s:10,e:12}]}, {i: '21', p: 'قاضوی محمد', x: 'زن', r: 'g', t: [{d:4,s:13,e:15}]}, {i: '22', p: 'قاضوی محمد', x: 'مرد', r: 'g', t: [{d:4,s:15,e:17}]}, {i: '23', p: 'نجفی برزگر', x: 'زن', t: [{d:2,s:8,e:10}]}, {i: '24', p: 'نجفی برزگر', x: 'مرد', t: [{d:2,s:10,e:12}]}, {i: '25', p: 'ملک‌مکان', x: 'زن', t: [{d:2,s:13,e:15}]}, {i: '26', p: 'قربانی عباس', x: 'مرد', r: 'r', t: [{d:2,s:15,e:17}]}, {i: '27', p: 'دهقانی زهیر', x: 'مرد', r: 'g', t: [{d:4,s:8,e:10}]}, {i: '28', p: 'دهقانی زهیر', x: 'زن', r: 'g', t: [{d:4,s:10,e:12}]}, {i: '29', p: 'احمدی مسلم', x: 'مرد', r: 'g', t: [{d:3,s:8,e:10}]}, {i: '30', p: 'احمدی مسلم', x: 'زن', r: 'g', t: [{d:3,s:10,e:12}]}, {i: '31', p: 'عسگری یزدی', x: 'مرد', r: 'r', t: [{d:1,s:13,e:15}]}, {i: '32', p: 'عسگری یزدی', x: 'زن', r: 'r', t: [{d:1,s:15,e:17}]}]},
        { id: '1120009', t: 'انقلاب اسلامی', c: 'general', u: 2, g: [{i: '03', p: 'سقای‌بی‌ریا', x: 'زن', t: [{d:4,s:8,e:10}]}, {i: '04', p: 'موسوی سیدرضا', x: 'زن', r: 'r', t: [{d:0,s:8,e:10}]}, {i: '05', p: 'موسوی سیدرضا', x: 'مرد', r: 'r', t: [{d:0,s:10,e:12}]}, {i: '06', p: 'موسوی سیدرضا', x: 'مرد', r: 'r', t: [{d:4,s:8,e:10}]}, {i: '07', p: 'موسوی سیدرضا', x: 'زن', r: 'r', t: [{d:4,s:10,e:12}]}, {i: '08', p: 'اسماعیلی علی', x: 'مرد', r: 'r', t: [{d:4,s:10,e:12}]}, {i: '09', p: 'اسماعیلی علی', x: 'زن', r: 'r', t: [{d:4,s:13,e:15}]}, {i: '10', p: 'واعظی عباس', x: 'زن', t: [{d:2,s:13,e:15}]}, {i: '11', p: 'واعظی عباس', x: 'مرد', t: [{d:2,s:15,e:17}]}, {i: '12', p: 'برخورداری', x: 'مرد', t: [{d:3,s:13,e:15}]}, {i: '16', p: 'کشوردوست', x: 'زن', t: [{d:4,s:7.5,e:9}]}, {i: '17', p: 'برخورداری', x: 'زن', t: [{d:4,s:9,e:10.5}]}, {i: '18', p: 'سلیمانی غلامعلی', x: 'مرد', t: [{d:4,s:13,e:15}]}, {i: '19', p: 'اخضریان', x: 'مرد', t: [{d:4,s:15,e:17}]}, {i: '20', p: 'نصیری رضا', x: 'زن', t: [{d:2,s:10.5,e:12}]}, {i: '21', p: 'نباتیان', x: 'مرد', t: [{d:0,s:10.5,e:12}]}, {i: '22', p: 'نباتیان', x: 'مرد', t: [{d:0,s:13,e:15}]}, {i: '23', p: 'محمدزاده حسن', x: 'مرد', t: [{d:0,s:15,e:17}]}, {i: '30', p: 'سقای‌بی‌ریا', x: 'زن', t: [{d:1,s:8,e:10}]}, {i: '31', p: 'سقای‌بی‌ریا', x: 'زن', t: [{d:1,s:10,e:12}]}]},
        { id: '1120019', t: 'دانش خانواده', c: 'general', u: 2, g: [{i: '03', p: 'ملکی ندا', x: 'زن', t: [{d:0,s:8,e:10}]}, {i: '04', p: 'ملکی ندا', x: 'زن', t: [{d:0,s:10,e:12}]}, {i: '05', p: 'شعربافچی', x: 'زن', r: 'g', t: [{d:4,s:8,e:10}]}, {i: '06', p: 'شعربافچی', x: 'زن', r: 'g', t: [{d:4,s:10,e:12}]}, {i: '07', p: 'خسروشاهی', x: 'زن', t: [{d:3,s:8,e:10}]}, {i: '08', p: 'شریفی محمد', x: 'مرد', t: [{d:4,s:13,e:15}]}, {i: '09', p: 'محمدزاده', x: 'زن', r: 'g', t: [{d:1,s:13,e:15}]}, {i: '10', p: 'بهاری', x: 'مرد', r: 'g', t: [{d:1,s:15,e:17}]}, {i: '11', p: 'ریحانی سعید', x: 'مرد', r: 'g', t: [{d:4,s:8,e:10}]}, {i: '12', p: 'ریحانی سعید', x: 'مرد', r: 'g', t: [{d:4,s:10,e:12}]}, {i: '13', p: 'نیاز آزاده', x: 'زن', r: 'g', t: [{d:4,s:8,e:10}]}, {i: '14', p: 'نیاز آزاده', x: 'زن', r: 'g', t: [{d:4,s:10,e:12}]}, {i: '19', p: 'مرادی منصور', x: 'مرد', r: 'y', t: [{d:4,s:8,e:10}]}, {i: '20', p: 'مرادی منصور', x: 'مرد', r: 'y', t: [{d:4,s:10,e:12}]}, {i: '21', p: 'ریحانی سعید', x: 'مرد', r: 'g', t: [{d:3,s:8,e:10}]}, {i: '22', p: 'ریحانی سعید', x: 'مرد', r: 'g', t: [{d:3,s:10,e:12}]}, {i: '23', p: 'گروه آموزشی', x: 'مرد', t: [{d:0,s:13,e:15}]}, {i: '24', p: 'گروه آموزشی', x: 'مرد', t: [{d:0,s:15,e:17}]}, {i: '25', p: 'ملکی ندا', x: 'زن', t: [{d:1,s:8,e:10}]}, {i: '26', p: 'ملکی ندا', x: 'زن', t: [{d:1,s:10,e:12}]}]},
        { id: '1120020', t: 'تربیت بدنی (پسران)', c: 'general', u: 1, g: [{i: '01', p: 'کیانی خسرو', x: 'مرد', t: [{d:0,s:8,e:10}]}, {i: '02', p: 'مومنی‌فر', x: 'مرد', t: [{d:0,s:10,e:12}]}, {i: '03', p: 'سنجری محمد', x: 'مرد', t: [{d:0,s:13,e:15}]}, {i: '05', p: 'حسینی روح‌الله', x: 'مرد', t: [{d:1,s:8,e:10}]}, {i: '07', p: 'تکلو نیما', x: 'مرد', t: [{d:1,s:13,e:15}]}, {i: '08', p: 'تکلو نیما', x: 'مرد', t: [{d:1,s:15,e:17}]}, {i: '09', p: 'حسینی/امینانی', x: 'مرد', t: [{d:2,s:8,e:10}]}, {i: '10', p: 'امینانی', x: 'مرد', t: [{d:2,s:10,e:12}]}, {i: '11', p: 'رحیم‌زاده', x: 'مرد', t: [{d:2,s:13,e:15}]}, {i: '12', p: 'کردی حسن', x: 'مرد', t: [{d:2,s:15,e:17}]}, {i: '13', p: 'محمودی احمد', x: 'مرد', t: [{d:3,s:8,e:10}]}, {i: '14', p: 'زیویار فرزاد', x: 'مرد', t: [{d:3,s:10,e:12}]}, {i: '15', p: 'محبی محمود', x: 'مرد', t: [{d:3,s:13,e:15}]}, {i: '16', p: 'محبی محمود', x: 'مرد', t: [{d:3,s:15,e:17}]}, {i: '17', p: 'کیانی خسرو', x: 'مرد', t: [{d:4,s:8,e:10}]}, {i: '18', p: 'زیویار فرزاد', x: 'مرد', t: [{d:4,s:10,e:12}]}, {i: '19', p: 'زیویار فرزاد', x: 'مرد', t: [{d:4,s:13,e:15}]}, {i: '20', p: 'فلاحی زانیار', x: 'مرد', t: [{d:4,s:15,e:17}]}]},
        { id: '1120021', t: 'ورزش ۱ (پسران)', c: 'general', u: 1, g: [{i: '01', p: 'کردی حسن', x: 'مرد', t: [{d:0,s:8,e:10}]}, {i: '02', p: 'ذوقی', x: 'مرد', t: [{d:0,s:10,e:12}]}, {i: '03', p: 'ذوقی', x: 'مرد', t: [{d:0,s:13,e:15}]}, {i: '04', p: 'کردی حسن', x: 'مرد', t: [{d:0,s:15,e:17}]}, {i: '05', p: 'بختیاری', x: 'مرد', t: [{d:1,s:8,e:10}]}, {i: '06', p: 'بختیاری', x: 'مرد', t: [{d:1,s:10,e:12}]}]},

        {id:'8120121', t:'ریاضی عمومی ۱', c:'specialized', u: 3, g:[{i:'01', p:'محمودی داریان حسین', x:'مختلط', t:[{d:0,s:10.5,e:12}, {d:2,s:10.5,e:12}]}, {i:'02', p:'یاریگر روش مهدی رضا', x:'مختلط', t:[{d:1,s:10.5,e:12}, {d:3,s:10.5,e:12}]}, {i:'03', p:'یاریگر روش مهدی رضا', x:'مختلط', t:[{d:1,s:13.5,e:15}, {d:3,s:13.5,e:15}]}]},
        {id:'8120115', t:'فیزیک ۱', c:'specialized', u: 3, g:[{i:'01', p:'حسینیان سراجه لو اکرم', x:'مختلط', t:[{d:0,s:9,e:10.5}, {d:2,s:9,e:10.5}]}, {i:'02', p:'مجد نیره', x:'مختلط', t:[{d:1,s:9,e:10.5}, {d:3,s:9,e:10.5}]}]},
        {id:'8120106', t:'نقشه کشی صنعتی ۱', c:'specialized', u: 2, g:[{i:'01', p:'ایران نژاد پاریزی مصطفی', x:'مختلط', t:[{d:0,s:7.5,e:10.5}]}, {i:'02', p:'ایران نژاد پاریزی مصطفی', x:'مختلط', t:[{d:0,s:10.5,e:13.5}]}, {i:'03', p:'ایران نژاد پاریزی مصطفی', x:'مختلط', t:[{d:0,s:13.5,e:16.5}]}, {i:'04', p:'بیگ پوریان بهزاد', x:'مختلط', t:[{d:1,s:7.5,e:10.5}]}, {i:'05', p:'بیگ پوریان بهزاد', x:'مختلط', t:[{d:1,s:10.5,e:13.5}]}, {i:'06', p:'اشراقی ایمان', x:'مختلط', t:[{d:1,s:13.5,e:16.5}]}, {i:'07', p:'پور عبداله امید', x:'مختلط', t:[{d:2,s:13.5,e:16.5}]}, {i:'08', p:'اشراقی ایمان', x:'مختلط', t:[{d:3,s:13.5,e:16.5}]}]},
        {id:'8120025', t:'برنامه‌سازی کامپیوتر', c:'specialized', u: 3, g:[{i:'01', p:'مرتضوی محمدرضا', x:'مختلط', t:[{d:0,s:15,e:16.5}, {d:2,s:15,e:16.5}]}, {i:'02', p:'کمندی علی', x:'مختلط', t:[{d:1,s:15,e:16.5}, {d:3,s:15,e:16.5}]}]},
        {id:'8120012', t:'آزمایشگاه فیزیک ۱', c:'specialized', u: 1, g:[{i:'01', p:'حسینی سید محسن', x:'مختلط', t:[{d:0,s:7.5,e:9}]}, {i:'02', p:'حسینی سید محسن', x:'مختلط', t:[{d:0,s:10.5,e:12}]}, {i:'03', p:'حسینی سید محسن', x:'مختلط', t:[{d:0,s:13.5,e:15}]}, {i:'04', p:'حسینی سید محسن', x:'مختلط', t:[{d:0,s:15,e:16.5}]}, {i:'05', p:'حسینی سید محسن', x:'مختلط', t:[{d:1,s:7.5,e:9}]}, {i:'07', p:'حسینی سید محسن', x:'مختلط', t:[{d:1,s:10.5,e:12}]}, {i:'09', p:'حسینی سید محسن', x:'مختلط', t:[{d:1,s:13.5,e:15}]}, {i:'11', p:'حسینی سید محسن', x:'مختلط', t:[{d:1,s:15,e:16.5}]}, {i:'13', p:'حسینی سید محسن', x:'مختلط', t:[{d:2,s:7.5,e:9}]}, {i:'15', p:'حسینی سید محسن', x:'مختلط', t:[{d:2,s:10.5,e:12}]}, {i:'17', p:'حسینی سید محسن', x:'مختلط', t:[{d:2,s:13.5,e:15}]}, {i:'19', p:'حسینی سید محسن', x:'مختلط', t:[{d:2,s:15,e:16.5}]}, {i:'21', p:'حسینی سید محسن', x:'مختلط', t:[{d:3,s:7.5,e:9}]}, {i:'22', p:'حاتمی ماربینی صاعد', x:'مختلط', t:[{d:3,s:7.5,e:9}]}, {i:'23', p:'حسینی سید محسن', x:'مختلط', t:[{d:3,s:10.5,e:12}]}, {i:'24', p:'حاتمی ماربینی صاعد', x:'مختلط', t:[{d:3,s:10.5,e:12}]}, {i:'25', p:'حسینی سید محسن', x:'مختلط', t:[{d:3,s:13.5,e:15}]}, {i:'26', p:'حاتمی ماربینی صاعد', x:'مختلط', t:[{d:3,s:13.5,e:15}]}, {i:'27', p:'حسینی سید محسن', x:'مختلط', t:[{d:3,s:15,e:16.5}]}, {i:'28', p:'حاتمی ماربینی صاعد', x:'مختلط', t:[{d:3,s:15,e:16.5}]}, {i:'29', p:'محمد زاده امیرحسین', x:'مختلط', t:[{d:4,s:7.5,e:9}]}, {i:'31', p:'محمد زاده امیرحسین', x:'مختلط', t:[{d:4,s:10.5,e:12}]}, {i:'33', p:'محمد زاده امیرحسین', x:'مختلط', t:[{d:4,s:13.5,e:15}]}, {i:'35', p:'محمد زاده امیرحسین', x:'مختلط', t:[{d:4,s:15,e:16.5}]}]},
        {id:'8106027', t:'استاتیک', c:'specialized', u: 3, g:[{i:'01', p:'بنی اسدی مجید', x:'مختلط', t:[{d:0,s:9,e:10.5}, {d:2,s:9,e:10.5}]}, {i:'02', p:'حسینیان احسان', x:'مختلط', t:[{d:0,s:13.5,e:15}, {d:2,s:13.5,e:15}]}, {i:'03', p:'نظری محمد علی', x:'مختلط', t:[{d:1,s:9,e:10.5}, {d:3,s:9,e:10.5}]}]},
        {id:'8120122', t:'ریاضی عمومی ۲', c:'specialized', u: 3, g:[{i:'01', p:'مقدسی علی', x:'مختلط', t:[{d:0,s:7.5,e:9}, {d:2,s:7.5,e:9}]}, {i:'02', p:'مقدسی علی', x:'مختلط', t:[{d:0,s:9,e:10.5}, {d:2,s:9,e:10.5}]}, {i:'03', p:'عابدیان روح اله', x:'مختلط', t:[{d:0,s:10.5,e:12}, {d:2,s:10.5,e:12}]}, {i:'04', p:'قدوسیان امین', x:'مختلط', t:[{d:1,s:9,e:10.5}, {d:3,s:9,e:10.5}]}, {i:'05', p:'قدوسیان امین', x:'مختلط', t:[{d:1,s:10.5,e:12}, {d:3,s:10.5,e:12}]}, {i:'06', p:'معانی میاندوآب احسان', x:'مختلط', t:[{d:1,s:15,e:16.5}, {d:3,s:15,e:16.5}]}, {i:'07', p:'معانی میاندوآب احسان', x:'مختلط', t:[{d:1,s:16.5,e:18}, {d:3,s:16.5,e:18}]}]},
        {id:'8120097', t:'معادلات دیفرانسیل', c:'specialized', u: 3, g:[{i:'01', p:'رحامی حسین', x:'مختلط', t:[{d:0,s:7.5,e:9}, {d:2,s:7.5,e:9}]}, {i:'02', p:'رحامی حسین', x:'مختلط', t:[{d:0,s:9,e:10.5}, {d:2,s:9,e:10.5}]}, {i:'03', p:'ترابی سید عبدالرضا', x:'مختلط', t:[{d:0,s:7.5,e:9}, {d:2,s:7.5,e:9}]}, {i:'04', p:'ترابی سید عبدالرضا', x:'مختلط', t:[{d:0,s:9,e:10.5}, {d:2,s:9,e:10.5}]}, {i:'05', p:'جهانشاهی نجمه', x:'مختلط', t:[{d:0,s:13.5,e:15}, {d:2,s:13.5,e:15}]}, {i:'06', p:'خجسته علی', x:'مختلط', t:[{d:1,s:7.5,e:9}, {d:3,s:7.5,e:9}]}, {i:'07', p:'خجسته علی', x:'مختلط', t:[{d:1,s:9,e:10.5}, {d:3,s:9,e:10.5}]}, {i:'08', p:'باقرپور نگین', x:'مختلط', t:[{d:1,s:7.5,e:9}, {d:3,s:7.5,e:9}]}, {i:'09', p:'باقرپور نگین', x:'مختلط', t:[{d:1,s:9,e:10.5}, {d:3,s:9,e:10.5}]}]},
        {id:'8120141', t:'شیمی فیزیک', c:'specialized', u: 3, g:[{i:'01', p:'بایندری مقدم عبدالمجید', x:'مختلط', t:[{d:0,s:9,e:10.5}, {d:2,s:9,e:10.5}]}, {i:'02', p:'حسینیان سراجه لو اکرم', x:'مختلط', t:[{d:0,s:10.5,e:12}, {d:2,s:10.5,e:12}]}]},
        {id:'8120116', t:'فیزیک ۲', c:'specialized', u: 3, g:[{i:'01', p:'مجد نیره', x:'مختلط', t:[{d:0,s:10.5,e:12}, {d:2,s:10.5,e:12}]}, {i:'02', p:'مجد نیره', x:'مختلط', t:[{d:0,s:7.5,e:9}, {d:2,s:7.5,e:9}]}, {i:'03', p:'طالش جفادیده علیرضا', x:'مختلط', t:[{d:0,s:9,e:10.5}, {d:2,s:9,e:10.5}]}, {i:'04', p:'ذوقی مریم', x:'مختلط', t:[{d:0,s:10.5,e:12}, {d:2,s:10.5,e:12}]}, {i:'05', p:'ذوقی مریم', x:'مختلط', t:[{d:0,s:9,e:10.5}, {d:2,s:9,e:10.5}]}, {i:'06', p:'مانی ورنوسفادرانی اعظم', x:'مختلط', t:[{d:0,s:10.5,e:12}, {d:2,s:10.5,e:12}]}, {i:'07', p:'طالش جفادیده علیرضا', x:'مختلط', t:[{d:0,s:13.5,e:15}, {d:2,s:13.5,e:15}]}, {i:'08', p:'محمدی سمیه', x:'مختلط', t:[{d:1,s:9,e:10.5}, {d:3,s:9,e:10.5}]}, {i:'09', p:'شاطر زاده یزدی زهرا', x:'مختلط', t:[{d:1,s:10.5,e:12}, {d:3,s:10.5,e:12}]}]},
        {id:'8106391', t:'درآمدی بر مهندسی مکانیک', c:'specialized', u: 1, g:[{i:'01', p:'چینی سید فرشید', x:'مختلط', t:[{d:2,s:15,e:17}]}]},
        {id:'8106116', t:'دینامیک', c:'specialized', u: 4, g:[{i:'01', p:'رحمتی زهرا', x:'مختلط', t:[{d:1,s:9,e:10.5}, {d:3,s:9,e:10.5}]}]},
        {id:'8106202', t:'علم مواد', c:'specialized', u: 3, g:[{i:'01', p:'فرجی قادر', x:'مختلط', t:[{d:1,s:15,e:16.5}, {d:3,s:15,e:16.5}]}]},
        {id:'8106513', t:'مکانیک مواد ۱', c:'specialized', u: 3, g:[{i:'01', p:'حقیقی یزدی مجتبی', x:'مختلط', t:[{d:0,s:13.5,e:15}, {d:2,s:13.5,e:15}]}]},
        {id:'8120047', t:'ریاضی مهندسی', c:'specialized', u: 3, g:[{i:'01', p:'(نام استاد ذکر نشده)', x:'مختلط', t:[{d:1,s:10.5,e:12}, {d:3,s:10.5,e:12}]}, {i:'02', p:'امیری هادی', x:'مختلط', t:[{d:0,s:16.5,e:18}, {d:2,s:16.5,e:18}]}]},
        {id:'8106220', t:'کارگاه ماشین ابزار', c:'specialized', u: 1, g:[{i:'01', p:'صادقی علیرضا', x:'مختلط', t:[{d:0,s:16.5,e:18.5}]}, {i:'02', p:'صادقی علیرضا', x:'مختلط', t:[{d:1,s:13,e:15}]}, {i:'03', p:'صادقی علیرضا', x:'مختلط', t:[{d:1,s:16.5,e:18.5}]}, {i:'04', p:'صادقی علیرضا', x:'مختلط', t:[{d:2,s:13.25,e:15}]}, {i:'05', p:'صادقی علیرضا', x:'مختلط', t:[{d:2,s:16.5,e:18.5}]}]},
        {id:'8120013', t:'آزمایشگاه فیزیک ۲', c:'specialized', u: 1, g:[{i:'01', p:'رضایی مرجان', x:'مختلط', t:[{d:0,s:7.5,e:9}]}, {i:'02', p:'رضایی مرجان', x:'مختلط', t:[{d:0,s:10.5,e:12}]}, {i:'03', p:'رضایی مرجان', x:'مختلط', t:[{d:0,s:13.5,e:15}]}, {i:'04', p:'رضایی مرجان', x:'مختلط', t:[{d:1,s:7.5,e:9}]}, {i:'05', p:'رضایی مرجان', x:'مختلط', t:[{d:1,s:10.5,e:12}]}, {i:'06', p:'رضایی مرجان', x:'مختلط', t:[{d:1,s:13.5,e:15}]}, {i:'07', p:'رضایی مرجان', x:'مختلط', t:[{d:2,s:7.5,e:9}]}, {i:'08', p:'رضایی مرجان', x:'مختلط', t:[{d:2,s:10.5,e:12}]}, {i:'09', p:'رضایی مرجان', x:'مختلط', t:[{d:2,s:13.5,e:15}]}, {i:'10', p:'رضایی مرجان', x:'مختلط', t:[{d:3,s:7.5,e:9}]}, {i:'11', p:'رضایی مرجان', x:'مختلط', t:[{d:3,s:10.5,e:12}]}, {i:'12', p:'رضایی مرجان', x:'مختلط', t:[{d:3,s:13.5,e:15}]}, {i:'13', p:'رضایی مرجان', x:'مختلط', t:[{d:4,s:7.5,e:9}]}, {i:'14', p:'رضایی مرجان', x:'مختلط', t:[{d:4,s:10.5,e:12}]}, {i:'15', p:'رضایی مرجان', x:'مختلط', t:[{d:4,s:13.5,e:15}]}]}
    ];

    let courses = [];
    let currentTab = 'specialized';
    let plans = [{ id: 0, selections: {}, checked: {} }]; 
    let activePlanIndex = 0;
    
    // --- State for Unified Modal ---
    let tempNewCourse = { profs: [] };
    let isEditingMode = false;
    let editingCourseId = null;

    function initGrid() {
        const timeLabelsContainer = document.getElementById('timeLabels');
        timeLabelsContainer.innerHTML = '';
        for(let h = START_HOUR; h <= END_HOUR; h++) {
            const div = document.createElement('div');
            div.className = 'time-label';
            div.innerText = `${h}:00`;
            timeLabelsContainer.appendChild(div);
        }
        const totalHeight = (END_HOUR - START_HOUR + 1) * PX_PER_HOUR;
        document.querySelectorAll('.day-lane').forEach(lane => lane.style.height = totalHeight + 'px');
    }

    function loadState() {
        // Theme
        const theme = localStorage.getItem(THEME_KEY);
        if(theme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }

        const savedCourses = localStorage.getItem(COURSE_DATA_KEY);
        if (savedCourses) courses = JSON.parse(savedCourses);
        else courses = JSON.parse(JSON.stringify(defaultCourses));

        courses.forEach((c, i) => {
            if(!c.color) c.color = c.c === 'specialized' ? `c-sp-${(i % 8) + 1}` : 'c-gen';
            // Ensure units exist if loaded from old local storage
            if(c.u === undefined) c.u = 2; // Default fallback
        });

        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
            const parsed = JSON.parse(data);
            plans = parsed.plans || [{ id: 0, selections: {}, checked: {} }];
            activePlanIndex = parsed.activePlanIndex || 0;
            plans.forEach(p => { if(!p.checked) p.checked = {}; });
        }
        renderPlanTabs();
        updateUnitCounter();
    }

    function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ plans, activePlanIndex })); updateUnitCounter(); }
    function saveCourses() { localStorage.setItem(COURSE_DATA_KEY, JSON.stringify(courses)); renderCourseList(); renderSchedule(); updateUnitCounter(); }
    
    // --- DARK MODE ---
    function toggleTheme() {
        if(document.documentElement.getAttribute('data-theme') === 'dark') {
            document.documentElement.removeAttribute('data-theme');
            localStorage.setItem(THEME_KEY, 'light');
        } else {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem(THEME_KEY, 'dark');
        }
    }

    // --- TIME HELPERS ---
    function decimalToTimeStr(dec) {
        let h = Math.floor(dec);
        let m = Math.round((dec - h) * 60);
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }
    
    function timeStrToDecimal(str) {
        if(!str) return 0;
        const [h, m] = str.split(':').map(Number);
        return h + (m / 60);
    }

    // --- UNIT COUNTER LOGIC ---
    function updateUnitCounter() {
        let total = 0;
        const sels = plans[activePlanIndex].selections;
        // Iterate only selected groups
        Object.keys(sels).forEach(courseId => {
            if (sels[courseId] && sels[courseId] !== 'none') {
                const c = courses.find(x => x.id === courseId);
                if(c) total += (c.u || 0);
            }
        });

        const display = document.getElementById('unitDisplay');
        const box = document.getElementById('unitBox');
        
        // Animate counting
        const start = parseInt(display.innerText);
        if(start !== total) {
             display.innerText = total;
        }

        if(total > 20) {
            box.classList.add('limit-exceeded');
        } else {
            box.classList.remove('limit-exceeded');
        }
    }

    function renderPlanTabs() {
        const container = document.getElementById('planTabsContainer');
        container.querySelectorAll('.plan-tab').forEach(t => t.remove());
        plans.forEach((plan, index) => {
            const btn = document.createElement('button');
            btn.className = `plan-tab ${index === activePlanIndex ? 'active' : ''}`;
            btn.onclick = () => switchPlan(index);
            btn.innerHTML = `<span class="desktop-only">برنامه </span><span>${index + 1}</span>`;
            container.insertBefore(btn, container.lastElementChild);
        });
    }

    function switchPlan(index) {
        activePlanIndex = index;
        saveState();
        renderPlanTabs();
        renderCourseList();
        renderSchedule();
        updateUnitCounter();
    }

    function addNewPlan() {
        plans.push({ id: plans.length, selections: {}, checked: {} });
        activePlanIndex = plans.length - 1;
        saveState();
        renderPlanTabs();
        renderCourseList();
        renderSchedule();
    }

    function deleteCurrentPlan() {
        if (plans.length === 1) {
            if(confirm('پاکسازی برنامه؟')) { 
                plans[0].selections = {}; 
                plans[0].checked = {};
                saveState(); renderCourseList(); renderSchedule(); 
            }
            return;
        }
        if(confirm('حذف این برنامه؟')) {
            plans.splice(activePlanIndex, 1);
            activePlanIndex = Math.max(0, activePlanIndex - 1);
            plans.forEach((p, i) => p.id = i);
            saveState(); renderPlanTabs(); renderCourseList(); renderSchedule();
        }
    }

    function setTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.onclick.toString().includes(tab)));
        renderCourseList();
    }
    
    function formatClassTimes(times) {
        if(!times || !times.length) return '';
        const groups = {};
        times.forEach(t => {
            const timeKey = `${formatTime(t.s)}-${formatTime(t.e)}`;
            if(!groups[timeKey]) groups[timeKey] = [];
            groups[timeKey].push(dayNames[t.d]);
        });
        return Object.entries(groups).map(([time, days]) => `${days.join('، ')} ${time}`).join(' | ');
    }

    function renderCourseList() {
        const query = document.getElementById('searchInput').value.trim();
        const container = document.getElementById('accordion-container');
        container.innerHTML = '';
        const currentSelections = plans[activePlanIndex].selections;
        const currentChecked = plans[activePlanIndex].checked;

        let visible = courses.filter(c => c.c === currentTab && (c.t.includes(query) || c.id.includes(query) || c.g.some(g => g.p.includes(query))));

        visible.sort((a, b) => {
            const isCheckedA = currentChecked[a.id];
            const isCheckedB = currentChecked[b.id];
            if (isCheckedA && !isCheckedB) return -1;
            if (!isCheckedA && isCheckedB) return 1;
            return 0;
        });

        visible.forEach(c => {
            const item = document.createElement('div');
            const selection = currentSelections[c.id] || 'none';
            const isChecked = currentChecked[c.id] || false;
            
            item.className = `course-group ${isChecked ? 'selected-course' : ''}`;
            item.style.setProperty('--course-color', getComputedStyle(document.documentElement).getPropertyValue(getCssVarName(c.color)) || getHexColor(c.color));

            const checkedHtml = isChecked ? icons.check : '';
            
            let html = `
            <div class="accordion-header" onclick="toggleAccordion(this)">
                <div class="header-main">
                    <div class="custom-checkbox" onclick="toggleCourseCheck(event, '${c.id}')">${checkedHtml}</div>
                    <span>${c.t}</span>
                    <span class="course-units-badge">${c.u} واحد</span>
                </div>
                <div class="header-actions">
                    <span style="font-size:0.8em; background:rgba(0,0,0,0.1); padding:2px 6px; border-radius:4px">${c.g.length}</span>
                    <button class="icon-btn" onclick="openCourseModal('edit', '${c.id}')">${icons.pencil}</button>
                </div>
            </div>
            <div class="accordion-body">
                <div class="prof-grid">
                    <label class="prof-option">
                        <input type="radio" name="${c.id}" value="none" ${selection === 'none' ? 'checked' : ''} onchange="handleSelection('${c.id}', 'none')">
                        <span class="prof-card"><span>انتخاب نشده</span></span>
                    </label>`;
            
            c.g.forEach(g => {
                const timeStr = formatClassTimes(g.t);
                html += `<label class="prof-option">
                    <input type="radio" name="${c.id}" value="${g.i}" ${selection === g.i ? 'checked' : ''} onchange="handleSelection('${c.id}', '${g.i}')">
                    <span class="prof-card">
                        <div style="display:flex; flex-direction:column">
                            <span>${g.p}${g.r ? `<span class="rank-dot rank-${g.r}"></span>` : ''}</span>
                            <span style="font-size:0.75em; color:var(--text-secondary); margin-top:2px">${timeStr}</span>
                        </div>
                        ${g.x ? `<span style="font-size:0.8em; opacity:0.7">${g.x}</span>` : ''}
                    </span>
                </label>`;
            });

            item.innerHTML = html + `</div></div>`;
            container.appendChild(item);
        });
    }

    function getCssVarName(className) {
        const map = {
            'c-sp-1': '#e74c3c', 'c-sp-2': '#e67e22', 'c-sp-3': '#f1c40f', 'c-sp-4': '#2ecc71',
            'c-sp-5': '#1abc9c', 'c-sp-6': '#3498db', 'c-sp-7': '#9b59b6', 'c-sp-8': '#34495e',
            'c-gen': '#95a5a6'
        };
        return map[className] || '#333';
    }
    function getHexColor(className) { return getCssVarName(className); }

    function toggleAccordion(header) {
        header.classList.toggle('active');
        header.nextElementSibling.classList.toggle('open');
    }

    function toggleCourseCheck(e, courseId) {
        e.stopPropagation();
        const currentChecked = plans[activePlanIndex].checked;
        if (currentChecked[courseId]) {
            delete currentChecked[courseId];
        } else {
            currentChecked[courseId] = true;
        }
        saveState();
        renderCourseList();
    }

    function handleSelection(courseId, groupId) {
        if (groupId !== 'none') {
            plans[activePlanIndex].checked[courseId] = true;
        }
        plans[activePlanIndex].selections[courseId] = groupId;
        saveState();
        renderCourseList();
        renderSchedule();
        updateUnitCounter();
    }

    // --- UNIFIED MODAL LOGIC (ADD/EDIT) ---
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    function openCourseModal(mode, courseId = null) {
        isEditingMode = (mode === 'edit');
        editingCourseId = courseId;
        
        document.getElementById('courseModalTitle').innerText = isEditingMode ? 'ویرایش درس' : 'افزودن درس جدید';
        document.getElementById('deleteCourseBtn').style.display = isEditingMode ? 'block' : 'none';

        if (isEditingMode) {
            const c = courses.find(x => x.id === courseId);
            document.getElementById('ncName').value = c.t;
            document.getElementById('ncCat').value = c.c;
            document.getElementById('ncUnits').value = c.u || 3;
            
            // Map existing data to temp structure
            tempNewCourse = {
                profs: c.g.map(g => ({
                    id: g.i,
                    name: g.p,
                    times: g.t.map(t => ({
                        day: t.d,
                        start: decimalToTimeStr(t.s),
                        end: decimalToTimeStr(t.e)
                    }))
                }))
            };
        } else {
            // Reset for new
            document.getElementById('ncName').value = '';
            document.getElementById('ncCat').value = 'specialized';
            document.getElementById('ncUnits').value = 3;
            tempNewCourse = { profs: [{ id: Date.now(), name: '', times: [{day: 0, start: '08:00', end: '10:00'}] }] };
        }

        renderModalContent();
        document.getElementById('courseModal').classList.add('active');
    }

    function renderModalContent() {
        const container = document.getElementById('ncProfsContainer');
        container.innerHTML = '';
        
        tempNewCourse.profs.forEach((prof, pIdx) => {
            const pDiv = document.createElement('div');
            pDiv.className = 'prof-entry-card';
            
            let html = `
                <div class="prof-header">
                    <input type="text" class="form-input" placeholder="نام استاد" 
                           value="${prof.name}" oninput="updateProfName(${pIdx}, this.value)" style="width:70%">
                    <button class="btn btn-sm btn-danger" onclick="removeProfField(${pIdx})">حذف</button>
                </div>
                <div style="font-size:0.85em; margin-bottom:5px; color:var(--text-secondary)">زمان‌های کلاس:</div>
            `;
            
            prof.times.forEach((t, tIdx) => {
                html += `
                    <div class="time-slot-row">
                        <select class="form-select" onchange="updateTime(${pIdx}, ${tIdx}, 'day', this.value)" style="flex:1">
                            <option value="0" ${t.day==0?'selected':''}>شنبه</option>
                            <option value="1" ${t.day==1?'selected':''}>یک‌شنبه</option>
                            <option value="2" ${t.day==2?'selected':''}>دوشنبه</option>
                            <option value="3" ${t.day==3?'selected':''}>سه‌شنبه</option>
                            <option value="4" ${t.day==4?'selected':''}>چهارشنبه</option>
                        </select>
                        <input type="time" class="form-input" value="${t.start}" onchange="updateTime(${pIdx}, ${tIdx}, 'start', this.value)" style="width:90px">
                        <input type="time" class="form-input" value="${t.end}" onchange="updateTime(${pIdx}, ${tIdx}, 'end', this.value)" style="width:90px">
                        <button class="icon-btn btn-sm-danger" onclick="removeTimeField(${pIdx}, ${tIdx})">${icons.trash}</button>
                    </div>
                `;
            });
            
            html += `<button class="btn btn-secondary btn-sm" onclick="addTimeField(${pIdx})" style="margin-top:5px; width:100%">+ زمان دیگر</button>`;
            pDiv.innerHTML = html;
            container.appendChild(pDiv);
        });
    }

    function addProfField() {
        tempNewCourse.profs.push({ id: Date.now(), name: '', times: [{day: 0, start: '08:00', end: '10:00'}] });
        renderModalContent();
    }
    function removeProfField(idx) {
        if(tempNewCourse.profs.length <= 1 && !confirm('حذف تنها استاد؟')) return;
        tempNewCourse.profs.splice(idx, 1);
        renderModalContent();
    }
    function updateProfName(idx, val) { tempNewCourse.profs[idx].name = val; }
    
    function addTimeField(pIdx) {
        tempNewCourse.profs[pIdx].times.push({day: 0, start: '08:00', end: '10:00'});
        renderModalContent();
    }
    function removeTimeField(pIdx, tIdx) {
        if(tempNewCourse.profs[pIdx].times.length === 1) return alert('حداقل یک زمان لازم است');
        tempNewCourse.profs[pIdx].times.splice(tIdx, 1);
        renderModalContent();
    }
    function updateTime(pIdx, tIdx, field, val) {
        if (field === 'day') val = parseInt(val);
        // Start/End are strings 'HH:MM' from input[time], passed directly
        tempNewCourse.profs[pIdx].times[tIdx][field] = val;
    }

    function submitCourseForm() {
        const name = document.getElementById('ncName').value.trim();
        const cat = document.getElementById('ncCat').value;
        const units = parseInt(document.getElementById('ncUnits').value) || 0;
        
        if(!name) return alert("نام درس الزامی است");
        
        const validProfs = tempNewCourse.profs.filter(p => p.name.trim() !== '');
        if(validProfs.length === 0) return alert("حداقل نام یک استاد را وارد کنید");

        const newGroups = validProfs.map((p, idx) => ({
            i: p.id.toString().startsWith('C') ? p.id : 'C' + Date.now() + idx, // Keep ID if editing, generate if new
            p: p.name,
            x: 'نامشخص',
            t: p.times.map(t => ({
                d: t.day, 
                s: timeStrToDecimal(t.start), 
                e: timeStrToDecimal(t.end)
            }))
        }));

        if (isEditingMode) {
            const cIndex = courses.findIndex(c => c.id === editingCourseId);
            if (cIndex > -1) {
                courses[cIndex].t = name;
                courses[cIndex].c = cat;
                courses[cIndex].u = units; // Update units
                courses[cIndex].g = newGroups;
                // If the selected group was removed, reset selection
                plans.forEach(plan => {
                   if (plan.selections[editingCourseId]) {
                       const groupExists = newGroups.find(g => g.i === plan.selections[editingCourseId]);
                       if (!groupExists) plan.selections[editingCourseId] = 'none';
                   }
                });
            }
        } else {
            const newCourse = {
                id: 'C-' + Date.now(),
                t: name,
                c: cat,
                u: units, // Save units
                color: cat === 'specialized' ? 'c-sp-8' : 'c-gen',
                g: newGroups
            };
            courses.push(newCourse);
        }

        saveCourses();
        saveState();
        closeModal('courseModal');
    }

    function deleteEntireCourse() {
        if(!isEditingMode || !editingCourseId) return;
        if(!confirm('آیا از حذف کامل این درس و تمام اساتید آن اطمینان دارید؟')) return;
        
        plans.forEach(p => { delete p.selections[editingCourseId]; delete p.checked[editingCourseId]; });
        courses = courses.filter(c => c.id !== editingCourseId);
        
        saveCourses(); saveState(); 
        closeModal('courseModal');
    }

    // --- SCHEDULE RENDER & DELETION ---
    function attachDeletionListeners(el, courseId) {
        el.addEventListener('dblclick', () => { handleSelection(courseId, 'none'); });
        let timer;
        const start = () => { timer = setTimeout(() => { if(confirm("حذف درس از برنامه؟")) handleSelection(courseId, 'none'); }, 700); };
        const cancel = () => clearTimeout(timer);
        el.addEventListener('touchstart', start, {passive: true});
        el.addEventListener('touchend', cancel);
        el.addEventListener('touchmove', cancel);
    }

    function renderSchedule() {
        for(let i=0; i<5; i++) document.getElementById(`day-${i}`).innerHTML = '';
        const events = [];
        const isMobile = window.innerWidth <= 900;
        const currentSelections = plans[activePlanIndex].selections;

        courses.forEach(c => {
            const gid = currentSelections[c.id];
            if (gid && gid !== 'none') {
                const group = c.g.find(g => g.i === gid);
                if(group) group.t.forEach(t => events.push({title: (isMobile && shortNames[c.t]) ? shortNames[c.t] : c.t, prof: isMobile ? group.p.split(' ')[0] : group.p, day: t.d, start: t.s, end: t.e, color: c.color, id: c.id}));
            }
        });

        events.sort((a,b) => a.start - b.start);
        const processed = new Set();
        for (let i = 0; i < events.length; i++) {
            if (processed.has(i)) continue;
            let cluster = [events[i]]; processed.add(i);
            for (let j = i + 1; j < events.length; j++) {
                if (!processed.has(j) && events[j].day === events[i].day && Math.max(events[i].start, events[j].start) < Math.min(events[i].end, events[j].end)) { cluster.push(events[j]); processed.add(j); }
            }
            cluster.forEach((ev, idx) => { ev.width = (96/cluster.length) - (cluster.length>1?1:0); ev.left = 2 + (idx*(96/cluster.length)); ev.conf = cluster.length>1; });
        }

        events.forEach(ev => {
            const el = document.createElement('div');
            el.className = `event ${ev.color} ${ev.conf ? 'conflict-overlap' : ''}`;
            el.style.top = `${(ev.start-START_HOUR)*PX_PER_HOUR}px`;
            el.style.height = `${(ev.end-ev.start)*PX_PER_HOUR}px`;
            el.style.width = `calc(${ev.width}% - ${ev.conf?2:0}px)`;
            el.style.left = `${ev.left}%`;
            el.innerHTML = `<span class="event-time">${formatTime(ev.start)}${!isMobile ? ' - '+formatTime(ev.end) : ''}</span><strong>${ev.title}</strong><span class="event-prof">${ev.prof}</span>`;
            el.title = isMobile ? "برای حذف نگه دارید" : "برای حذف دوبار کلیک کنید";
            attachDeletionListeners(el, ev.id);
            document.getElementById(`day-${ev.day}`).appendChild(el);
        });
    }

    function formatTime(t) { const h = Math.floor(t), m = Math.round((t-h)*60); return `${h}:${m===0?'00':m.toString().padStart(2, '0')}`; }
    window.addEventListener('resize', renderSchedule); 
    initGrid(); loadState(); renderCourseList(); renderSchedule();
</script>
</body>
</html>
